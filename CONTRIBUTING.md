# Contributing to the project

This project has been built and maintained using Vagrant and VirtualBox. The project uses oakensoul/ansible-citadel
for the box. Included in the box are Ansible, BOTO, the AWS CLI, etc. Everything you'll need to develop or run Ansilbe
playbooks, libraries and modules. If you find something else that really should be in that box, feel free to post an
issue for that project.

## Installation

### Dependencies

In order to run the tests included with the development environment, you must have Vagrant and VirtualBox installed.

We also recommend using the vagrant plugin "vagrant-vbguest" to prevent the VirtualBox guest additions from getting
out of sync.

```bash
$ vagrant plugin install vagrant-vbguest
```

### Setup

To begin using the environment, you will need to fork it from GitHub and then clone it locally.

```bash
$ git clone git@github.com:{yourusername}/ansible-library-redshift.git
```

### Vagrant

Once you have the repository cloned, you need only spin up your Vagrant environment. If you need information about
how to use Vagrant, please see the http://vagrantup.com website. For this documentation, we'll assume you have at
least entry level Vagrant knowledge. If you don't, feel free to use the Issues section of the repository to ask questions.

The project directory is mapped inside the Guest VM in the folder `/vagrant`.

## Automation and Development

### Create your inventory files

We've copied the most recent (at the time of creation) version of the ec2 dynamic inventory scripts mentioned in the
Ansible documentation. [Example EC2 External Inventory Script](http://docs.ansible.com/intro_dynamic_inventory.html#example-aws-ec2-external-inventory-script)

The inventory script is located in tests/inventory/ec2.py

It's an executable script, so you can run it by hand to see what it returns for your inventory if you need to figure out
the best ways to target your resources.

You will need to configure it so that it can find your Redshift instance that you wish to test with. The tests will
all be configured for using the CloudFormation template that is included. When you create your role to use the library
you can use the ec2.ini as an example.

#### Configure AWS CLI
As this project uses Redshift, you will likely want to configure your AWS CLI so that you can run the included test
scripts.

```bash
$ aws configure
```

You will probably want to set your default region to `us-east-1` and your default output format to `json`.

#### MFA Token
If your account requires the use of an MFA token, you will need to create a token using the Amazon Simple Token Service
(STS). Once you've created the token you will need to place the values it returns into environment variables.

The command below asks for your MFA serial number, which can be found on your users IAM details, and is usually
represented by an `arn:aws:iam:bunchofnumbers:mfa/username`

The mfa token code is generated by your iphone app, or fob, whatever you're using.

```bash
$ aws sts get-session-token --serial-number {serial number here} --token-code {mfa token here}
```

You will receive output that looks something like the following:
```bash
{
    "Credentials": {
        "SecretAccessKey": "IwK1V7ASDFADSFADFASDFASDFadsfasdfasdfadsfasdfasdf45gsdfg", 
        "SessionToken": "AQoDYXdzEGsagALvxo+QSQkIk3qQuJ9SPIs4A/hi+qZJeQBEb4h545yhb45hb45yb45yb4hy54CB8IqUyIyS8r6I4Y/Nu+EoO4Q22GJbumCu1QGE2islfkgjlkKJTSfdgj5lkjW+5aYF", 
        "Expiration": "2015-02-10T13:30:45Z", 
        "AccessKeyId": "ASIAZZ7ZZZZZZZZDFASDFASDFADF"
    }
}
```

This will output a JSON string. You will need to copy the values inside the JSON string into environment variables,
using something like the following:
```bash
$ export AWS_ACCESS_KEY_ID={AccessKeyIdFromResponse}
$ export AWS_SECRET_ACCESS_KEY={SecretAccessKeyFromResponse}
$ export AWS_SECURITY_TOKEN={SessionTokenFromResponse}
```

Note: Hopefully at some point, someone will turn this into some kind of script to make it easier, for now, you just have
to do some manual commands and copy-paste efforts.

#### Private Key
You will need to make sure you have the private key, or create a public/private key placed into the `~/.ssh/` folder
inside the guest VM in order for SSH to function into your VM. Further instructions will be added for this soon.

#### Spin up the EC2 Server

Once you're done, you can now provision your EC2 instance, by running a similar command to the following inside the Guest VM:
```bash
$ ansible-playbook /vagrant/ansible/playbooks/provision-ec2.yml --inventory-file=/vagrant/ansible/inventory/ec2
```

## Testing
Currently, the "testing" for the module is really just running the test playbooks and make sure that everything works.
That and manually verifying through SQL that the actions you expect to have happened did. I wish I had time to build
out the proper Mock systems, but I don't have the time or experience with Python to do that at the moment.

To run the included test script(s) you will need to have your environment configured to use the ec2 inventory script,
then you can run the following:
```bash
$ ansible-playbook /vagrant/tests/test.yml --inventory-file=/vagrant/inventory/ec2.py --connection=local -M library/redshift/
```

It's much easier to type all that if you go into the directory where the playbook you're trying to run lives.
```bash
$ cd \vagrant\tests
$ ansible-playbook test.yml --inventory=inventory/ec2 --connection=local -M library/redshift/
```

